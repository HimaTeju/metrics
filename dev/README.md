This is a docker-compose configuration to be used **only** for development purpose.

It is recommended to use it in combination with Mutagen to effeciently sync data from your machine to the Docker containers.

## List of containers

### backend

This container is athebackend web server.

### backend-tools

This container is simply a Python stack with all backend requirements but no web server. Context is
setup with appropriate environment variables. Usefull for instance to run alembic.

### backend-tests

This container is simply a Python stack with all backend requirements but no web server. Context is
setup with appropriate environment variables for tests (i.e. it uses the test DB). Usefull to run
tests locally.

### frontend-ui

This container hosts the frontend UI for end-users.

## Instructions

First start the Docker-Compose stack:

```sh
cd dev
docker compose -p offspot_metrics up -d
```

## Setup DB

If this is your first run or if you made any schema change, you need to set/update the DB schema before having all containers OK.

Start a shell in the backend-tools container.

```sh
docker exec -it om_backend-tools /bin/sh
```

Once inside the container, ask Alembic to update the schema

```sh
alembic upgrade head
```

You can also check that everything is ok

```sh
alembic check
```

Note that to run integration tests, we use a separate DB, you hence have to set/update the DB schema as well.
Just do the same as above with the backend-tests container (instead of the backend-tools)

## Restart the backend

The backend might typically fail if the DB schema is not up-to-date, or if you create some nasty bug while modifying the code.

Restart it with:
```sh
docker restart om_backend
```

Other containers might be restarted the same way.

## Browse the web UI

Open [the web UI](http://localhost:8001) in your favorite browser.

## Run tests

Do not forget to set/update the test DB schema

Start a shell in the backend-tests container.

```sh
docker exec -it om_backend-tests python -m pytest
```

You can select one specific set of tests by path

```sh
python -m pytest tests/integration/routes/users
```

Or just one specific test function

```sh
python -m pytest tests/integration/routes/users -k test_list_no_auth
```

### backend database schema

The configuration to generate a schema of the backend database is stored in backend/docs/schemaspy. It is based on a static website generated by SchemaSpy.

To generate DB schema documentation, you can run the following command once your 
docker-compose setup is ready (and supposing that your local DB is up-to-date):

```sh
cd backend
docker run --network offspot_metrics_default -v "$(pwd)/docs/schemaspy.properties:/schemaspy.properties" -v "$(pwd)/docs/schemaspy:/output" schemaspy/schemaspy:latest
```